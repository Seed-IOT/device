# device
> 设备管理服务、协议相关

## TODO

- [ ] 协议生成
- [ ] 协议变更
- [ ] 协议删除
- [ ] 协议查询

## 运行
```
make run
```

## 依赖

* mysql
* emqx
* redis

## mqtt 主题

上报状态

`/mqtt/%e/up`

下发数据

`/mqtt/%e/dn`

绑定关系推送

`/mqtt/%app/relevance`

```
[
	{
		"sno": "",
		"bind": true
	}
]
```

## Header
> 协议头用来定义一些上层操作，是上报、下发、发送location

名称 | 长度(byte) | 描述
:-: | :-: | :-: | :-: | :-: | :-:
包头 | 4 | 0x00000001 |
包长度 | 1～4 | cmd到payload，单位byte |
cmd | 2 | 可选：0x0001上报、0x0002下发、0x0100发送位置信息 |
payload | max65535 | 报文内容 |


## Payload-上报

名称 | 长度(byte) | 描述
:-: | :-: | :-: | :-: | :-: | :-:
action | 1 | 可选：0x01状态上报、0x02回复查询 |
flag | ～ | 取所有数据点用二进制表示有效 |
data | ～ | 数据点值 |

## Payload-下发
> 下发的格式有两种，查询和下发状态，查询不需要data

名称 | 长度(byte) | 描述
:-: | :-: | :-: | :-: | :-: | :-:
action | 1 | 0x03查询 |
flag | ～ | 取可写数据点用二进制表示有效 |

名称 | 长度(byte) | 描述
:-: | :-: | :-: | :-: | :-: | :-:
action | 1 | 0x04下发数据点 |
flag | ～ | 取可写数据点用二进制表示有效 |
data | ～ | 数据点值 |

## Payload-location